<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Europe Travel Journal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body class="bg-light">
<div class="container my-4">
  <h1 class="mb-4 text-center">Europe Travel Journal</h1>

  <div id="message" class="mb-3"></div>

  <!-- New entry form -->
  <div class="card mb-4">
    <div class="card-header">Write a new entry</div>
    <div class="card-body">
      <form id="entry-form">
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label class="form-label">Date</label>
            <input type="date" name="date" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Country*</label>
            <input type="text" name="country" class="form-control" placeholder="Italy" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">City</label>
            <input type="text" name="city" class="form-control" placeholder="Rome">
          </div>
          <div class="col-md-3">
            <label class="form-label">Title*</label>
            <input type="text" name="title" class="form-control" placeholder="A day in Rome" required>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Story / Thoughts*</label>
          <textarea name="content" class="form-control" rows="4"
                    placeholder="Write about what you saw and how you felt..."
                    required></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Image URL (optional)</label>
          <input type="url" name="imageUrl" class="form-control"
                 placeholder="https://example.com/my-photo.jpg">
          <div class="form-text">
            Paste a link from Google Photos, iCloud, Imgur, etc.
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Save entry</button>
      </form>
    </div>
  </div>

  <!-- Country filter -->
  <div class="mb-3">
    <strong>Filter by country:</strong>
    <select id="country-filter" class="form-select form-select-sm" style="max-width: 250px; display: inline-block;">
      <option value="All">All countries</option>
    </select>
  </div>

  <!-- Entries list -->
  <div class="card">
    <div class="card-header">Entries</div>
    <div class="card-body" id="entries-container">
      <p class="text-muted">Loading entries...</p>
    </div>
  </div>
</div>

<script>
  const API_URL = '/api/entries';
  const messageDiv = document.getElementById('message');
  const form = document.getElementById('entry-form');
  const entriesContainer = document.getElementById('entries-container');
  const countryFilter = document.getElementById('country-filter');

  let allEntries = [];

  function showMessage(text, type = 'success') {
    if (!text) {
      messageDiv.textContent = '';
      messageDiv.className = '';
      return;
    }
    messageDiv.textContent = text;
    messageDiv.className = type === 'error' ? 'alert alert-danger' : 'alert alert-success';
    setTimeout(() => showMessage('', ''), 4000);
  }

  async function fetchEntries() {
    try {
      const res = await fetch(API_URL);
      const json = await res.json();
      if (!json.success) throw new Error(json.error || 'Failed to load entries');
      allEntries = json.data || [];
      updateCountryFilter();
      renderEntries();
    } catch (err) {
      console.error(err);
      showMessage('Error loading entries', 'error');
      entriesContainer.innerHTML = '<p class="text-danger">Error loading entries.</p>';
    }
  }

  function updateCountryFilter() {
    const countries = Array.from(new Set(allEntries.map(e => e.country))).sort();
    const current = countryFilter.value || 'All';

    countryFilter.innerHTML = '<option value="All">All countries</option>';
    countries.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      countryFilter.appendChild(opt);
    });

    if (countries.includes(current)) {
      countryFilter.value = current;
    } else {
      countryFilter.value = 'All';
    }
  }

  function renderEntries() {
    const selected = countryFilter.value || 'All';
    const entriesToShow = selected === 'All'
      ? allEntries
      : allEntries.filter(e => e.country === selected);

    if (!entriesToShow.length) {
      entriesContainer.innerHTML = '<p class="text-muted">No entries yet.</p>';
      return;
    }

    entriesContainer.innerHTML = '';
    entriesToShow
      .slice()
      .sort((a, b) => (b.date || '').localeCompare(a.date || ''))  // newest first
      .forEach(entry => {
        const div = document.createElement('div');
        div.className = 'mb-4';

        const header = document.createElement('h5');
        header.textContent = `${entry.date || ''} â€“ ${entry.title} `;
        const locationSpan = document.createElement('span');
        locationSpan.className = 'text-muted';
        locationSpan.textContent = `(${entry.country}${entry.city ? ', ' + entry.city : ''})`;
        header.appendChild(locationSpan);

        const created = document.createElement('p');
        created.className = 'text-muted small';
        created.textContent = `Created at ${entry.createdAt}`;

        div.appendChild(header);
        div.appendChild(created);

        if (entry.imageUrl) {
          const img = document.createElement('img');
          img.src = entry.imageUrl;
          img.alt = 'photo';
          img.className = 'img-fluid mb-2';
          div.appendChild(img);
        }

        const p = document.createElement('p');
        p.style.whiteSpace = 'pre-wrap';
        p.textContent = entry.content;
        div.appendChild(p);

        div.appendChild(document.createElement('hr'));

        entriesContainer.appendChild(div);
      });
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const payload = {
      date: formData.get('date'),
      country: formData.get('country'),
      city: formData.get('city'),
      title: formData.get('title'),
      content: formData.get('content'),
      imageUrl: formData.get('imageUrl'),
    };

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const json = await res.json();

      if (!res.ok || !json.success) {
        showMessage(json.error || 'Error saving entry', 'error');
        console.error('Missing fields:', json.missingFields);
        return;
      }

      showMessage('Entry saved!', 'success');
      form.reset();
      await fetchEntries();
    } catch (err) {
      console.error(err);
      showMessage('Network error while saving entry', 'error');
    }
  });

  countryFilter.addEventListener('change', renderEntries);

  // initial load
  fetchEntries();
</script>
</body>
</html>
